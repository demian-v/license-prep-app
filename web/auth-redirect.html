<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Email Verification - USA License Prep</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      color: #333;
    }
    
    .container {
      background: white;
      width: 100%;
      max-width: 400px;
      border-radius: 24px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
      overflow: hidden;
      text-align: center;
      position: relative;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 24px 20px 16px;
      position: relative;
    }
    
    .back-arrow {
      position: absolute;
      left: 20px;
      top: 24px;
      width: 24px;
      height: 24px;
      cursor: pointer;
      opacity: 0.8;
    }
    
    .header h1 {
      font-size: 20px;
      font-weight: 500;
      margin: 0;
      color: white;
    }
    
    .content {
      padding: 40px 32px;
    }
    
    .email-icon-container {
      width: 120px;
      height: 120px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 32px;
      position: relative;
      box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
    }
    
    .email-icon {
      width: 48px;
      height: 48px;
      fill: white;
    }
    
    .success-checkmark {
      position: absolute;
      top: -8px;
      right: -8px;
      width: 36px;
      height: 36px;
      background: #4CAF50;
      border-radius: 50%;
      display: none;
      align-items: center;
      justify-content: center;
      border: 4px solid white;
      box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
    }
    
    .checkmark-icon {
      width: 16px;
      height: 16px;
      fill: white;
    }
    
    .spinner {
      position: absolute;
      top: -4px;
      left: -4px;
      right: -4px;
      bottom: -4px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top: 3px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .title {
      font-size: 24px;
      font-weight: 600;
      color: #1a1a1a;
      margin-bottom: 16px;
      line-height: 1.3;
    }
    
    .message {
      font-size: 16px;
      color: #666;
      line-height: 1.5;
      margin-bottom: 24px;
    }
    
    .email-address {
      font-weight: 600;
      color: #333;
      word-break: break-all;
    }
    
    .action-button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 16px 32px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 16px;
      min-width: 200px;
      display: none;
    }
    
    .action-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }
    
    .back-link {
      color: #667eea;
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      display: none;
    }
    
    .back-link:hover {
      text-decoration: underline;
    }
    
    .error-state .email-icon-container {
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
    }
    
    .error-state .action-button {
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
    }
    
    .debug-info {
      position: fixed;
      bottom: 20px;
      left: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 12px;
      border-radius: 8px;
      font-size: 12px;
      display: none;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .debug-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.1);
      border: none;
      color: rgba(0, 0, 0, 0.5);
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
    }
    
    @media (max-width: 480px) {
      .container {
        margin: 10px;
        border-radius: 16px;
      }
      
      .content {
        padding: 32px 24px;
      }
      
      .email-icon-container {
        width: 100px;
        height: 100px;
      }
      
      .email-icon {
        width: 40px;
        height: 40px;
      }
      
      .title {
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="container" id="main-container">
    <div class="header">
      <svg class="back-arrow" viewBox="0 0 24 24" fill="currentColor" onclick="goBack()">
        <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
      </svg>
      <h1 id="header-title">Verify Your Email</h1>
    </div>
    
    <div class="content">
      <div class="email-icon-container" id="icon-container">
        <div class="spinner" id="spinner"></div>
        <svg class="email-icon" viewBox="0 0 24 24" fill="currentColor">
          <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
        </svg>
        <div class="success-checkmark" id="success-check">
          <svg class="checkmark-icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
          </svg>
        </div>
      </div>
      
      <h2 class="title" id="main-title">Verifying Your Email</h2>
      <p class="message" id="main-message">
        Please wait while we verify your new email address...
      </p>
      
      <button class="action-button" id="action-btn" onclick="openApp()">
        Open App
      </button>
      
      <a href="#" class="back-link" id="back-link" onclick="goBack()">
        Back to Login
      </a>
    </div>
  </div>
  
  <button class="debug-toggle" onclick="toggleDebug()">Debug</button>
  <div class="debug-info" id="debug-info">
    <div><strong>Mode:</strong> <span id="debug-mode">-</span></div>
    <div><strong>Code:</strong> <span id="debug-code">-</span></div>
    <div><strong>Platform:</strong> <span id="debug-platform">-</span></div>
    <div><strong>Status:</strong> <span id="debug-status">-</span></div>
    <div><strong>Error:</strong> <span id="debug-error">-</span></div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: 'AIzaSyA7dyK2oMy7NKeVt9sMDxlsgOcTGQwAXFc',
      appId: '1:987638335534:web:d0f5efb48f240e567937bf',
      messagingSenderId: '987638335534',
      projectId: 'licenseprepapp',
      authDomain: 'licenseprepapp.firebaseapp.com',
      storageBucket: 'licenseprepapp.appspot.com',
      measurementId: 'G-8TTZX72V8P',
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    // State management
    let currentState = 'loading';
    let platform = 'unknown';
    let mode = null;
    let oobCode = null;
    let verificationError = null;

    // DOM elements
    const elements = {
      container: document.getElementById('main-container'),
      headerTitle: document.getElementById('header-title'),
      iconContainer: document.getElementById('icon-container'),
      spinner: document.getElementById('spinner'),
      successCheck: document.getElementById('success-check'),
      title: document.getElementById('main-title'),
      message: document.getElementById('main-message'),
      actionButton: document.getElementById('action-btn'),
      backLink: document.getElementById('back-link'),
      debugInfo: document.getElementById('debug-info')
    };

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      platform = detectPlatform();
      parseUrlParams();
      updateDebugInfo();
      
      if (oobCode) {
        // Handle both Firebase's 'action' mode and our custom 'verifyAndChangeEmail' mode
        if (mode === 'action' || mode === 'verifyAndChangeEmail') {
          determineActionTypeAndHandle();
        } else if (mode) {
          handleOtherModes();
        } else {
          showError('Invalid verification link', 'This link appears to be invalid or expired. Please try requesting a new verification email.');
        }
      } else {
        showError('Invalid verification link', 'This link appears to be invalid or expired. Please try requesting a new verification email.');
      }
    });

    function parseUrlParams() {
      const urlParams = new URLSearchParams(window.location.search);
      mode = urlParams.get('mode');
      oobCode = urlParams.get('oobCode');
      
      document.getElementById('debug-mode').textContent = mode || 'Not provided';
      document.getElementById('debug-code').textContent = oobCode ? oobCode.substring(0, 8) + '...' : 'Not provided';
      document.getElementById('debug-platform').textContent = platform;
    }

    function detectPlatform() {
      const ua = navigator.userAgent.toLowerCase();
      if (ua.includes('iphone') || ua.includes('ipad') || ua.includes('ipod')) {
        return 'iOS';
      } else if (ua.includes('android')) {
        return 'Android';
      } else {
        return 'Other';
      }
    }

    async function determineActionTypeAndHandle() {
      try {
        updateState('loading');
        updateDebugStatus('Determining action type from Firebase...');
        
        // Use Firebase Auth to check what type of action this code is for
        const info = await auth.checkActionCode(oobCode);
        updateDebugStatus('Action code checked successfully');
        
        // Log the operation type for debugging
        const operation = info.operation;
        updateDebugStatus(`Action type: ${operation}`);
        
        // Handle different types of operations
        switch (operation) {
          case 'VERIFY_AND_CHANGE_EMAIL':
          case 'VERIFY_EMAIL':
            updateDebugStatus('Handling email verification');
            await handleEmailVerification();
            break;
            
          case 'PASSWORD_RESET':
            updateDebugStatus('Handling password reset');
            elements.headerTitle.textContent = 'Password Reset';
            elements.title.textContent = 'Reset Your Password';
            elements.message.textContent = 'Opening the app to complete your password reset...';
            
            setTimeout(() => {
              openApp('reset-password');
            }, 1500);
            break;
            
          case 'RECOVER_EMAIL':
            updateDebugStatus('Handling email recovery');
            elements.headerTitle.textContent = 'Email Recovery';
            elements.title.textContent = 'Recover Your Email';
            elements.message.textContent = 'Processing your email recovery request...';
            
            setTimeout(() => {
              openApp('profile');
            }, 1500);
            break;
            
          default:
            updateDebugStatus(`Unknown operation type: ${operation}`);
            // Default to email verification for unknown types
            await handleEmailVerification();
            break;
        }
        
      } catch (error) {
        console.error('Error checking action code:', error);
        updateDebugStatus('Error checking action code: ' + error.message);
        
        // If we can't determine the action type, try email verification anyway
        updateDebugStatus('Falling back to email verification');
        await handleEmailVerification();
      }
    }

    async function handleEmailVerification() {
      try {
        updateState('loading');
        updateDebugStatus('Starting email verification...');
        
        // Apply the action code to verify the email
        await auth.applyActionCode(oobCode);
        
        updateDebugStatus('Email verification successful');
        updateState('success');
        
        // Wait a moment then redirect to app
        setTimeout(() => {
          openApp();
        }, 2500);
        
      } catch (error) {
        console.error('Email verification failed:', error);
        verificationError = error;
        updateDebugStatus('Verification failed: ' + error.message);
        
        let errorTitle = 'Verification Failed';
        let errorMessage = 'We couldn\'t verify your email address. ';
        
        if (error.code === 'auth/expired-action-code') {
          errorMessage += 'This verification link has expired. Please request a new one from your profile settings.';
        } else if (error.code === 'auth/invalid-action-code') {
          errorMessage += 'This verification link is invalid or has already been used.';
        } else if (error.code === 'auth/user-disabled') {
          errorMessage += 'Your account has been disabled. Please contact support.';
        } else {
          errorMessage += 'Please try again or request a new verification email.';
        }
        
        showError(errorTitle, errorMessage);
      }
    }

    function handleOtherModes() {
      // Handle other Firebase Auth modes (password reset, etc.)
      updateDebugStatus('Handling mode: ' + mode);
      
      if (mode === 'resetPassword') {
        elements.headerTitle.textContent = 'Password Reset';
        elements.title.textContent = 'Reset Your Password';
        elements.message.textContent = 'Opening the app to complete your password reset...';
        
        setTimeout(() => {
          openApp('reset-password');
        }, 1500);
      } else {
        // Redirect to app with the mode and code
        setTimeout(() => {
          openApp(mode);
        }, 1000);
      }
    }

    function updateState(newState) {
      currentState = newState;
      
      switch (newState) {
        case 'loading':
          elements.spinner.style.display = 'block';
          elements.successCheck.style.display = 'none';
          elements.container.classList.remove('error-state');
          elements.title.textContent = 'Verifying Your Email';
          elements.message.textContent = 'Please wait while we verify your new email address...';
          elements.actionButton.style.display = 'none';
          elements.backLink.style.display = 'none';
          break;
          
        case 'success':
          elements.spinner.style.display = 'none';
          elements.successCheck.style.display = 'flex';
          elements.container.classList.remove('error-state');
          elements.title.textContent = 'Email Verified!';
          elements.message.textContent = 'Your email address has been successfully verified. Opening the app...';
          elements.actionButton.style.display = 'inline-block';
          elements.actionButton.textContent = 'Open App';
          elements.backLink.style.display = 'none';
          break;
          
        case 'error':
          elements.spinner.style.display = 'none';
          elements.successCheck.style.display = 'none';
          elements.container.classList.add('error-state');
          elements.actionButton.style.display = 'inline-block';
          elements.actionButton.textContent = 'Try Again';
          elements.backLink.style.display = 'inline-block';
          break;
      }
    }

    function showError(title, message) {
      updateState('error');
      elements.headerTitle.textContent = 'Verification Error';
      elements.title.textContent = title;
      elements.message.textContent = message;
    }

    function openApp(route = 'profile') {
      updateDebugStatus('Opening app with route: ' + route);
      
      const schemes = [
        `licenseprep:///${route}`,
        `licenseprepapp:///${route}`
      ];
      
      if (platform === 'Android') {
        schemes.push(`intent:///${route}#Intent;scheme=licenseprep;package=com.license.prep.app;end`);
      }
      
      tryMultipleSchemes(schemes);
    }

    function tryMultipleSchemes(schemes) {
      let index = 0;
      
      function tryNext() {
        if (index < schemes.length) {
          const scheme = schemes[index];
          updateDebugStatus(`Trying scheme ${index + 1}/${schemes.length}: ${scheme}`);
          
          // Create a temporary link to test the scheme
          const link = document.createElement('a');
          link.href = scheme;
          link.style.display = 'none';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          
          index++;
          setTimeout(tryNext, 500);
        }
      }
      
      tryNext();
    }

    function goBack() {
      updateDebugStatus('Going back...');
      if (window.history.length > 1) {
        window.history.back();
      } else {
        openApp('login');
      }
    }

    function updateDebugInfo() {
      document.getElementById('debug-status').textContent = currentState;
      document.getElementById('debug-error').textContent = verificationError ? verificationError.message : 'None';
    }

    function updateDebugStatus(status) {
      document.getElementById('debug-status').textContent = status;
      console.log('Debug:', status);
    }

    function toggleDebug() {
      const debugInfo = elements.debugInfo;
      if (debugInfo.style.display === 'none' || debugInfo.style.display === '') {
        updateDebugInfo();
        debugInfo.style.display = 'block';
      } else {
        debugInfo.style.display = 'none';
      }
    }

    // Retry verification on button click when in error state
    elements.actionButton.addEventListener('click', function() {
      if (currentState === 'error' && mode === 'verifyAndChangeEmail') {
        handleEmailVerification();
      } else {
        openApp();
      }
    });
  </script>
</body>
</html>
